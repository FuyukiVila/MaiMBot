# 项目上下文信息

- MaiBot插件开发文档：欢迎来到MaiBot插件系统开发文档！这里是你开始插件开发旅程的最佳起点。主要内容包括：新手入门，组件功能详解，API浏览（消息发送与处理API，AI与生成API，表情包api，关系系统api，数据与配置API，工具API），实验性功能和支持信息。详细的开发文档分为：介绍，开发者与代码规范，项目结构（架构概述，文件结构，消息处理流程），适配器开发（开发综述，Adapter 开发指南），插件开发（开发指南，快速开始，Manifest系统指南，Actions系统，命令处理系统，工具系统，配置管理指南，依赖管理），API参考（发送API，消息API，聊天流API，LLM API，回复生成器API，表情包API，配置API，数据库API，人格API，工具API），Maim_Message参考（Maim_Message 概述，Message_Base，Router，命令参数表）。
- 插件配置完整指南：本文档全面指导如何为插件定义配置和在组件中访问配置。核心原则是任何时候都不要手动创建 config.toml 文件，系统会根据代码中定义的 config_schema 自动生成。配置架构分为 _manifest.json（元数据）和 config.toml（运行时配置）。支持配置版本管理，可在插件升级时自动迁移配置。配置定义通过在插件主类中设置 config_section_descriptions 和 config_schema 来完成，每个配置项使用 ConfigField 定义。在Action和Command中，通过 self.get_config() 方法访问配置值。
- 插件依赖管理系统：MaiBot插件系统提供Python包依赖管理功能。通过在插件类中添加 `python_dependencies` 字段来声明依赖。`python_dependencies` 是一个 `PythonDependency` 对象的列表，每个对象定义了一个包的依赖信息，包括 `package_name`, `version`, `optional`, `description`, 和 `install_name`。系统会在加载插件时自动检查依赖，并可以配置为自动安装。开发者可以在代码中通过 `try-except ImportError` 来处理可选依赖的缺失，实现功能的优雅降级。`plugin_manager` 提供 `check_all_dependencies()` 和 `generate_plugin_requirements()` 等API来管理和检查依赖。
- 快速开始指南：本指南将带你用5分钟时间，从零开始创建一个功能完整的MaiCore插件。步骤包括：创建插件目录、创建最简单的插件（一个继承自 BasePlugin 的类，并用 @register_plugin 装饰）、添加Action（继承自 BaseAction，实现 execute 方法）和Command（继承自 BaseCommand，设置 command_pattern 并实现 execute 方法）、了解并使用激活系统（如 ActionActivationType.KEYWORD）、添加配置文件（在插件类中定义 config_schema，系统会自动生成 config.toml），以及创建说明文档。Action是MaiCore根据意愿选择使用的“动作”，而Command是直接响应用户命令的。
- Action组件详解：Action是给麦麦在回复之外提供额外功能的智能组件，由麦麦的决策系统自主选择是否使用。Action采用两层决策机制：第一层是激活控制，决定Action是否进入决策候选池，激活类型包括 NEVER, ALWAYS, LLM_JUDGE, RANDOM, KEYWORD；第二层是使用决策，在Action被激活后，根据 action_require, action_parameters 等因素决定是否选择使用。每个Action类必须包含激活控制、基本信息、功能定义和执行方法。BaseAction提供了一些内置属性（如 message, user_id）和方法（如 get_config, send_text）。
- Command组件详解：Command是直接响应用户明确指令的组件，通过正则表达式匹配用户输入来被动触发。其特点是确定性执行、即时响应。每个Command类必须包含 `command_pattern`（正则表达式）、`command_help`、`command_examples` 和 `intercept_message`（布尔值，决定是否拦截消息）等属性。通过在 `command_pattern` 中使用命名组 `(?P<name>pattern)` 可以捕获参数，并通过 `self.matched_groups` 访问。与Action不同，Command用于提供具体的功能服务，而Action用于增强麦麦行为的拟人化。
- 插件Manifest系统指南：每个插件都必须包含一个 `_manifest.json` 文件，用于描述插件的元数据。这与 `config.toml`（运行时配置）构成了双文件架构。`_manifest.json` 包含必需字段（如 `manifest_version`, `name`, `version`, `description`, `author`）和可选字段。官方提供了 `manifest_tool.py` 脚本来帮助创建、扫描和验证 `_manifest.json` 文件。所有插件都必须有 `_manifest.json` 才能被加载。
- 消息发送API：该API负责发送各种类型的消息。导入方式为 `from src.plugin_system.apis import send_api`。主要功能包括发送文本、表情包、图片、命令和自定义消息到群聊或私聊。所有发送函数都是异步的，必须使用 `await`。函数名格式通常为 `[type]_to_[target]`，例如 `text_to_group` 和 `emoji_to_user`。还提供了一个通用的 `custom_message` 函数用于发送自定义消息。
- 消息API：该API提供消息查询、计数和格式化功能。导入方式为 `from src.plugin_system.apis import message_api`。可以按时间、聊天、用户等条件查询消息，例如 `get_messages_by_time` 和 `get_recent_messages`。可以统计新消息数量，例如 `count_new_messages`。可以将消息列表构建成可读的字符串，例如 `build_readable_messages_to_str`。`build_readable_messages_with_details` 和 `get_person_ids_from_messages` 是异步函数，需要使用 `await`。
- 聊天API：该API负责聊天信息的查询和管理。导入方式为 `from src.plugin_system.apis import chat_api`。主要功能包括获取所有、群聊或私聊的聊天流（`get_all_streams`, `get_group_streams`, `get_private_streams`），根据群ID或用户ID查找特定的聊天流（`get_stream_by_group_id`, `get_stream_by_user_id`），以及查询聊天流的类型和详细信息（`get_stream_type`, `get_stream_info`）。
- LLM API：该API提供与大语言模型交互的功能。导入方式为 `from src.plugin_system.apis import llm_api`。主要功能包括获取可用的模型配置（`get_available_models`）和使用指定模型生成内容（`generate_with_model`）。`generate_with_model` 是一个异步函数，需要 `await`，它接受 `prompt` 和 `model_config` 等参数，并返回一个元组，包含是否成功、生成的内容、推理过程和模型名称。
- 回复生成器API：该API提供智能回复生成功能。导入方式为 `from src.plugin_system.apis import generator_api`。主要功能包括获取回复器对象（`get_replyer`）、生成回复（`generate_reply`）和重写回复（`rewrite_reply`）。这些函数都是异步的，需要 `await`。`generate_reply` 会返回一个包含多种类型（如 text, emoji, image）回复的集合。
- 表情包API：该API提供表情包的获取、查询和管理功能。导入方式为 `from src.plugin_system.apis import emoji_api`。主要功能包括根据场景描述（`get_by_description`）、随机（`get_random`）或场景关键词（`get_by_emotion`）获取表情包。获取到的表情包是 base64 编码的。还提供查询表情包数量（`get_count`）、系统信息（`get_info`）、所有场景关键词（`get_emotions`）和所有描述（`get_descriptions`）的功能。获取表情包的函数都是异步的，需要 `await`。
- 个人信息API：该API提供用户信息查询和管理功能。导入方式为 `from src.plugin_system.apis import person_api`。主要功能包括根据平台和用户ID获取唯一的 `person_id`（`get_person_id`），根据 `person_id` 获取单个或多个用户信息字段（`get_person_value`, `get_person_values`），判断是否认识某个用户（`is_person_known`），以及根据用户名获取 `person_id`（`get_person_id_by_name`）。大部分查询函数都是异步的，需要 `await`。
- 数据库API：该API提供通用的数据库操作功能，采用Peewee ORM模型。导入方式为 `from src.plugin_system.apis import database_api`。核心函数是 `db_query`，它是一个通用的数据库操作接口，支持 `get`, `create`, `update`, `delete`, `count` 等操作。此外还提供了 `db_save` 和 `db_get` 等便捷函数。所有数据库API都是异步的，必须使用 `await`。常用的数据模型包括 `Messages`, `ActionRecords`, `UserInfo`, `GroupInfo`。
- 配置API：该API提供配置读取和用户信息获取功能。导入方式为 `from src.plugin_system.apis import config_api`。主要功能包括安全地从全局配置中获取值（`get_global_config`），从插件配置中获取值（`get_plugin_config`），根据用户名获取用户ID（`get_user_id_by_person_name`），以及获取用户信息（`get_person_info`）。用户信息相关的函数是异步的，需要 `await`。
- 工具API：该API提供各种辅助功能。导入方式为 `from src.plugin_system.apis import utils_api`。主要功能包括文件操作（`get_plugin_path`, `read_json_file`, `write_json_file`），时间相关（`get_timestamp`, `format_time`, `parse_time`），以及生成唯一ID（`generate_unique_id`）。
- 工具系统详解：工具系统是MaiBot的信息获取能力扩展组件，专门用于在Focus模式下拓宽麦麦能够获得的信息量。每个工具必须继承 `BaseTool` 基类并实现 `name`, `description`, `parameters` (JSONSchema格式) 和 `execute` 方法。工具采用自动发现和注册机制，系统会自动扫描 `tool_can_use` 目录并注册所有继承自 `BaseTool` 的类。工具系统仅在Focus模式下工作，且需要启用工具处理器。
